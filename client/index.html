<!DOCTYPE HTML>

<html>
	<head>
		<title>PvP MMO</title>
		<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	</head>

	<body>
		<div id="signDiv">
			Username: <input id="signDiv-username" type="text"/><br>
			Password: <input id="signDiv-password" type="password"/><br>
			<button id="signDiv-signIn">Sign In</button>
			<button id="signDiv-signUp">Sign Up</button>
		</div>
		
		<div id="gameDiv" style="display:none">
			<canvas id="ctx" width="500" height="500" style="border:1px solid #000000"></canvas>

			<div id="chat-text" style="width: 500px; height: 100px; overflow-y: scroll;">
				<div>
					<p>Hello!</p>
				</div>
			</div>
			<form id="chat-form">
				<input id="chat-input" type="text" style="width:500px;"/>
			</form>
		</div>
		
		
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.2/socket.io.js"></script>
		
		<script>
			
			var socket = io();
			
			//register/sign in
			
			var signDiv = document.getElementById('signDiv');

			var signDivUsername = document.getElementById('signDiv-username');
			
			var signDivSignIn = document.getElementById('signDiv-signIn');
			
			var signDivSignUp = document.getElementById('signDiv-signUp');
			
			var signDivPassword = document.getElementById('signDiv-password');
			
			signDivSignIn.onclick = function() {
				socket.emit('signIn', {
					username: signDivUsername.value,
					password: signDivPassword.value
				});
			}
			
			signDivSignUp.onclick = function() {
				socket.emit('signUp', {
					username: signDivUsername.value,
					password: signDivPassword.value
				});
			}
			
			socket.on('signInResponse', function(data) {
				if (data.success) {
					signDiv.style.display = 'none';
					document.getElementById("gameDiv").style.display = "inline-block";
				} else {
					alert('Sign in unsuccessful.');
				}
			});
			
			socket.on('signUpResponse', function(data) {
				if (data.success) {
					alert('You have made an account!')
				} else {
					alert('Such user already exists.');
				}
			});
			
			
			//game
			var canv = document.getElementById('ctx').getContext("2d");
			var chatText = document.getElementById('chat-text');
			var chatInput = document.getElementById('chat-input');
			var chatForm = document.getElementById('chat-form');
			
			socket.on('addToChat', function(data) {
				chatText.innerHTML += '<div><p>' + data + '</p></div>';
			});
			
			socket.on('evalAnswer', function(data) {
				console.log(data);
			});
			
			chatForm.onsubmit = function(e) {
				e.preventDefault();
				if (chatInput.value[0] === '/')
					socket.emit('evalServer', chatInput.value.slice(1));
				else
					socket.emit('sendMsgToServer', chatInput.value);
				chatInput.value = '';
			}
			
			var Player = function(initPack) {
				var self = {};
				self.id = initPack.id;
				self.number = initPack.number;
				self.x = initPack.x;
				self.y = initPack.y;
				
				Player.list[self.id] = self;
				return self;
			}
			
			Player.list = {};
			
			var Bullet = function(initPack) {
				var self = {};
				self.id = initPack.id;
				self.x = initPack.x;
				self.y = initPack.y;
				Bullet.list[self.id] = self;
				return self;
			}
			
			Bullet.list = {};
			
			
			//init - when new things are created, the package will contain all data
			
			socket.on('init', function(data) {
				for (var i = 0; i < data.player.length; i++) {
					new Player(data.player[i]);
				}
				for (var i = 0; i < data.bullet.length; i++) {
					new Bullet(data.bullet[i]);
				}
			});
			
			
			//update - difference between old package and new update
			
			socket.on('update', function(data) {
				for (var i = 0; i < data.player.length; i++) {
					var pack = data.player[i];
					var p = Player.list[pack.id];
					if (p) {
						if (pack.x !== undefined)
							p.x = pack.x;
						if (pack.y !== undefined) 
							p.y = pack.y
					}
				}
				for (var i = 0; i < data.bullet.length; i++) {
					var pack = data.bullet[i];
					var b = Bullet.list[data.bullet[i].id];
					if (b) {
						if (pack.x !== undefined)
							b.x = pack.x;
						if (pack.y !== undefined)
							b.y = pack.y;
					} 
				}
			});
			
			
			//remove - notifies client when a player was removed
			
			socket.on('remove', function(data) {
				for (var i = 0; i < data.player.length; i++) {
					delete Player.list[data.player[i]];
				}
				
				for (var i = 0; i < data.bullet.length; i++) {
					delete Bullet.list[data.bullet[i]];
				}
			});
			
			//draw to screen
			
			setInterval(function() {
				canv.clearRect(0, 0, 500, 500);
				for (var i in Player.list) {
					canv.fillText(Player.list[i].number, Player.list[i].x, Player.list[i].y);
				}
				for (var i in Bullet.list) {
					canv.fillRect(Bullet.list[i].x - 5, Bullet.list[i].y -5, 10, 10);
				}
			}, 40);
			
			
			socket.on('newPosition', function(data) {
				canv.clearRect(0, 0, 500, 500);
				for (var i = 0; i < data.player.length; i++) {
					canv.fillText(data.player[i].number, data.player[i].x, data.player[i].y);
				}
				for (var i = 0; i < data.bullet.length; i++) {
					canv.fillRect(data.bullet[i].x - 5, data.bullet[i].y - 5, 10, 10);
				}
			});
					
			document.onkeydown = function(e) {
				if (e.keyCode === 68) { //d
					socket.emit('keyPress', {
						inputId: 'right',
						state: true
					});
				}
				
				if (e.keyCode === 65) { //a
					socket.emit('keyPress', {
						inputId: 'left',
						state: true
					});
				}
				
				if (e.keyCode === 83) { //s
					socket.emit('keyPress', {
						inputId: 'down',
						state: true
					});
				}
				
				if (e.keyCode === 87) { //w
					socket.emit('keyPress', {
						inputId: 'up',
						state: true
					});
				}
			}
			
			document.onkeyup = function(e) {
				if (e.keyCode === 68) { //d
					socket.emit('keyPress', {
						inputId: 'right',
						state: false
					});
				}
				
				if (e.keyCode === 65) { //a
					socket.emit('keyPress', {
						inputId: 'left',
						state: false
					});
				}
				
				if (e.keyCode === 83) { //s
					socket.emit('keyPress', {
						inputId: 'down',
						state: false
					});
				}
				
				if (e.keyCode === 87) { //w
					socket.emit('keyPress', {
						inputId: 'up',
						state: false
					});
				}
			}
			
			document.onmousedown = function(e) {
				socket.emit('keyPress', {
					inputId: 'attack',
					state: true
				});
			}
			
			document.onmouseup = function(e) {
				socket.emit('keyPress', {
					inputId: 'attack',
					state: false
				});
			}
			
			document.onmousemove = function(e) {
				//Extract x and y relative to the middle of the screen.
				var x = -250 + e.clientX - 8;
				var y = -250 + e.clientY - 8;
				var angle = Math.atan2(y, x) / Math.PI * 180;
				socket.emit('keyPress', {
					inputId: 'mouseAngle',
					state: angle
				});
			}
			
		</script>
	</body>
</html>